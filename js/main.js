function taggingKeyEventHandler(e){if("INPUT"===e.target.tagName)return void e.preventDefault();if(e.keyCode>=49&&e.keyCode<=57){var t=e.keyCode-48,i=$("#words>.divider.active").last().nextAll(".divider").size(),a=i?i+1:0||$("#words li.char").size();a>t&&(a===$("#words li.char").size()?$("#words>.divider").eq(t-1).addClass("active"):$("#words>.divider.active").last().nextAll(".divider").eq(t-1).addClass("active"),generateTagger(),previewTaggingResult())}8===e.keyCode&&($("#words>.divider.active").last().removeClass("active"),generateTagger(),previewTaggingResult(),$("#words>.divider.active").size()||$("#preview").hide());var r={81:0,87:1,69:2,82:3,84:4,89:5,85:6,73:7,79:8,80:9,219:10,221:11};if(-1!==Object.keys(r).indexOf(""+e.keyCode)){$("#tagger select:focus option").eq(parseInt(r[""+e.keyCode])).prop("selected",!0);var n=parseInt($("#tagger select:focus").attr("tabindex"))+1;$('[tabindex="'+n+'"]').focus(),previewTaggingResult()}if(13===e.keyCode&&submitTaggingResult(STATE.editingAddress),192===e.keyCode&&reset(),77===e.keyCode&&($("#aside").toggleClass("active"),$(".container").toggleClass("menu-out")),37===e.keyCode){var s=parseInt($("#tagger select:focus").attr("tabindex"))-1;$('[tabindex="'+s+'"]').focus()}if(39===e.keyCode){var n=parseInt($("#tagger select:focus").attr("tabindex"))+1;$('[tabindex="'+n+'"]').focus()}}function initAddress(e){$("#words").empty();var t=e.split(""),i=[];$.each(t,function(e,a){var r='<li class="char">'+a+"</li>";e<t.length-1&&(r+='<li class="divider"></li>'),i.push(r)}),$("#words").append(i.join(""))}function loadAddressAndTagger(e){var t=JSON.parse(window.localStorage.getItem("addresses")),i=_.find(t,function(t){return t.original_address==e||t.corrected_address==e});if(initAddress(e),reset(),i.tags.length){var a=0;$.each(i.segmentation,function(e,t){a+=t.length,$("#words .divider").eq(a-1).addClass("active")}),generateTagger(),$.each(i.tags,function(e,t){$("#tagger select").eq(e).find('option[value="'+t+'"]').prop("selected",!0)}),previewTaggingResult()}}function getSegementation(){var e="",t=[];return $("#words>li").each(function(i){$(this).is(".char")&&(e+=$(this).text()),$(this).is(".divider.active")&&(t.push(e),e=""),i===$("#words>li").size()-1&&t.push(e)}),t}function generateTagger(){var e=OPTION.tags,t=getSegementation();if(t.length<2)return void $("#tagger").empty();var i=e.map(function(e,t){return 0===t?'<option value="'+e.value+'" selected>'+e.label+"</option>":'<option value="'+e.value+'">'+e.label+"</option>"}),a=$('<li class="select"><select class="form-control">'+i+"</select></li>"),r=$('<li class="divider"></li>'),n=$("#words>li.char").eq(0).width(),s=$("#words>li.divider").eq(0).width();$("#tagger").empty(),$.each(t,function(e,i){var d=a.clone();d.width(function(){return n*i.length+s*(i.length-1)}),d.find("select").attr("tabindex",e+2),$("#tagger").append(d),e<t.length-1&&$("#tagger").append(r.clone())})}function previewTaggingResult(){var e=getSegementation(),t=[];$("#tagger select").each(function(){t.push($(this).val())}),$("#preview").html(JSON.stringify(e)+"\n"+JSON.stringify(t)).show()}function submitTaggingResult(e){var t=JSON.parse(window.localStorage.getItem("addresses"));if(STATE.editingAddress){var i=getSegementation(),a=[];if($("#tagger select").each(function(){a.push($(this).val())}),a.length){var r=_.indexOf(t,_.find(t,{original_address:e}));t.splice(r,1,{original_address:e,corrected_address:"",tags:a,segmentation:i}),window.localStorage.setItem("addresses",JSON.stringify(t)),setTimeout(function(){loadFileStorage(),reset()},100)}}}function reset(){$("#words>.divider").removeClass("active"),$("#tagger").empty(),$("#preview").hide(),$("#corrector").hide(),$("#correct-input").val("")}function saveJsonStorage(e){window.localStorage.setItem("addresses",e)}function saveFileStorage(e){var t=e.split("\n"),i=[];$.each(t,function(e,t){i.push({original_address:t,corrected_address:"",segmentation:[],tags:[]})}),window.localStorage.setItem("addresses",JSON.stringify(i))}function saveCorrectedAddressToStorage(e,t){var i=JSON.parse(window.localStorage.getItem("addresses")),a=_.indexOf(i,_.find(i,{original_address:e}));i.splice(a,1,{original_address:e,corrected_address:t,tags:[],segmentation:[]}),window.localStorage.setItem("addresses",JSON.stringify(i))}function loadFileStorage(){var e=JSON.parse(window.localStorage.getItem("addresses"));if(e&&e.length){$("#candidates tbody").empty(),$.each(e,function(e,t){var i=t.corrected_address?t.corrected_address:t.original_address;$("#candidates tbody").append(t.tags.length?'<tr><td class="tagged">'+i+"</td></tr>":"<tr><td>"+i+"</td></tr>")});var t=_.find(e,function(e){return!e.tags.length}),i=_.indexOf(e,_.find(e,{original_address:t.original_address}));$("#candidates tbody tr").eq(i).find("td").addClass("editing"),initAddress(t.original_address),STATE.editingAddress=t.original_address}}function exportJson(){var e=window.localStorage.getItem("addresses");e=prettifyAddressJson(e);var t=new Blob([e],{type:"application/json"}),i=URL.createObjectURL(t),a=document.createElement("a");a.download="addresses.json",a.href=i;var r=document.createEvent("MouseEvents");r.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),a.dispatchEvent(r)}function prettifyAddressJson(e){return JSON.stringify(JSON.parse(e),function(e,t){return"tags"===e||"segmentation"===e?JSON.stringify(t):t},2).replace(/\\/g,"").replace(/\"\[/g,"[").replace(/\]\"/g,"]").replace(/\"\{/g,"{").replace(/\}\"/g,"}")}var OPTION={tags:[{value:"L1",label:"省／直辖市"},{value:"L2",label:"省会／地级市"},{value:"L3",label:"区／县"},{value:"L4",label:"街道／乡／镇"},{value:"L5",label:"道路／片区"},{value:"L6",label:"路号／村组"},{value:"L7",label:"楼／座／区／排"},{value:"L8",label:"单元／栋"},{value:"L9",label:"门牌"},{value:"POI",label:"POI"},{value:"DIR",label:"方位描述"},{value:"INS",label:"补充说明"}]},STATE={editingAddress:""};loadFileStorage(),$(".toggle-menu").click(function(){$("#aside").toggleClass("active"),$(".container").toggleClass("menu-out")}),$("#words").on("click",".divider",function(){$(this).toggleClass("active"),generateTagger(),previewTaggingResult(),$("#words>.divider.active").size()||$("#preview").hide()}),$("#preview-btn").click(function(){previewTaggingResult()}),$("#reset-btn").click(function(){reset()}),$("#confirm-btn").click(function(){submitTaggingResult(STATE.editingAddress)}),$("#correct-btn").click(function(){return STATE.editingAddress?($("#corrector").fadeToggle(),void $("#correct-input").val(STATE.editingAddress)):!1}),$("#correct-confirm").click(function(){$("#corrector").fadeOut();var e=STATE.editingAddress,t=$("#correct-input").val();saveCorrectedAddressToStorage(e,t),STATE.editingAddress=t,reset()}),$("#import-txt-btn").click(function(){$("#txt-upload").trigger("click")}),$("#import-json-btn").click(function(){$("#json-upload").trigger("click")}),$("#export-json-btn").click(function(){exportJson()}),$("#tagger").on("change","select",function(){previewTaggingResult()}),$("#candidates").on("click","td",function(){$(this).parent().siblings().find("td").removeClass("editing"),$(this).addClass("editing");var e=$(this).text();STATE.editingAddress=e,loadAddressAndTagger(e)}),$("#candidates").popover({container:"body",selector:"td",html:!0,content:function(){var e=$(this).text(),t=JSON.parse(window.localStorage.getItem("addresses")),i=_.find(t,function(t){return t.original_address==e||t.corrected_address==e});return"<pre>"+prettifyAddressJson(JSON.stringify(i))+"</pre>"},trigger:"hover"}),$(document).on("keyup",taggingKeyEventHandler),$(".focus-guard-start").on("focus",function(){$("#tagger select").eq(0).focus()}),$(".focus-guard-end").on("focus",function(){$("#tagger select").eq(0).focus()}),window.onload=function(){var e=document.getElementById("txt-upload");e.addEventListener("change",function(){var t=e.files[0],i=/text.*/;if(t.type.match(i)){var a=new FileReader;a.onload=function(){saveFileStorage(a.result),loadFileStorage(),reset()},a.readAsText(t)}else alert("格式不支持!")});var t=document.getElementById("json-upload");t.addEventListener("change",function(){var e=t.files[0];if("application/json"===e.type){var i=new FileReader;i.onload=function(){saveJsonStorage(i.result),loadFileStorage(),reset()},i.readAsText(e)}else alert("格式不支持!")})};